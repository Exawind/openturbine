<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example: Three Blade Rotor &mdash; Kynema 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Theory Manual" href="../theory/index.html" />
    <link rel="prev" title="Example: Spring-Mass System" href="spring_mass.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Kynema
              <img src="../_static/oturb_logo_v2.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="user.html">User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="compiling.html">Compiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="linking.html">Linking To Kynema</a></li>
<li class="toctree-l2"><a class="reference internal" href="vtk_visualization.html">VTK Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="floating_platform.html">Example: Rigid body with three springs</a></li>
<li class="toctree-l2"><a class="reference internal" href="turbine.html">Example: IEA15MW Turbine</a></li>
<li class="toctree-l2"><a class="reference internal" href="heavy_top.html">Example: Heavy Top Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="spring_mass.html">Example: Spring-Mass System</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Example: Three Blade Rotor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../theory/index.html">Theory Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgement.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kynema</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="user.html">User Manual</a></li>
      <li class="breadcrumb-item active">Example: Three Blade Rotor</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user/three_blade.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="example-three-blade-rotor">
<h1>Example: Three Blade Rotor<a class="headerlink" href="#example-three-blade-rotor" title="Permalink to this heading"></a></h1>
<p>This example will walk through how to run a simulation of a rotor made of three blades connected to a central hub.
We’ll use Kynema’s low level API, which, unlike Kynema’s high level APIs, will require us to manually set up all nodes and their connectivities.
This extra complexity is the trade-off required for unlimited freedom.
For the most up to date and working version of this code, see <code class="docutils literal notranslate"><span class="pre">tests/documentation_tests/three_blade_rotor/</span></code>.</p>
<p>As with any C++ program, start with the includes.
As a Kokkos-based library, you’ll need to include <code class="docutils literal notranslate"><span class="pre">Kokkos_Core.hpp</span></code> for setup, teardown, and working with Kynema’s data structures.
From Kynema, you’ll have to include <code class="docutils literal notranslate"><span class="pre">model.hpp</span></code> for the Model class, our tool for setting up and creating the system, and <code class="docutils literal notranslate"><span class="pre">step.hpp</span></code> for the Step function which performs the action of system asembly and solve.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;array&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Kokkos_Core.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;model/model.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;step/step.hpp&gt;</span>
</pre></div>
</div>
<p>We now create the main function of our program and initialize Kokkos.
We also start a scope around the rest of the program.
This scoping is necessary to ensure that all Kokkos objects are destroyed before finalize is called and the program exits.
Failure to do this will result in lots of nasty, hard to decipher errors on program termination.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Kokkos</span><span class="o">::</span><span class="n">initialize</span><span class="p">();</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Kokkos</span><span class="o">::</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, we will need to define our Beam Sections, which consist of the mass and stiffness matrices defined at given nodes along the beam.
These physical properties will be interpolated to the quadrature points for use in our simulation.
This problem uses a constant-cross-section blade, so the sections at the root and tip of the beam will be identical, but any number of complex cross-sections can be modeled.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">mass_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">8.538e-2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">8.538e-2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">8.538e-2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.4433e-2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.40972e-2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0336e-2</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">stiffness_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">1368.17e3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">88.56e3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">38.78e3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">16.9600e3</span><span class="p">,</span><span class="w"> </span><span class="mf">17.6100e3</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3510e3</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">17.6100e3</span><span class="p">,</span><span class="w"> </span><span class="mf">59.1200e3</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3700e3</span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3510e3</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3700e3</span><span class="p">,</span><span class="w"> </span><span class="mf">141.470e3</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">sections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">{</span>
<span class="w">    </span><span class="n">kynema</span><span class="o">::</span><span class="n">BeamSection</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="n">mass_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">stiffness_matrix</span><span class="p">),</span>
<span class="w">    </span><span class="n">kynema</span><span class="o">::</span><span class="n">BeamSection</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="n">mass_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">stiffness_matrix</span><span class="p">),</span>
<span class="p">};</span>
</pre></div>
</div>
<p>We now define the node locations where our solution will be defined.
In this case, we will use the a six node GLL basis.
Like the sections, these will be defined along the blade’s reference axis.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">node_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span>
<span class="w">    </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.11747233803526763</span><span class="p">,</span><span class="w"> </span><span class="mf">0.35738424175967748</span><span class="p">,</span><span class="w"> </span><span class="mf">0.64261575824032247</span><span class="p">,</span><span class="w"> </span><span class="mf">0.88252766196473242</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span>
<span class="p">};</span>
</pre></div>
</div>
<p>As a final piece of information, we will define the quadrature points and their weights.
We’ve precalculated these to be a seven point GL quadrature rule, which will be sufficiently accurate for both our basis and mass/stiffness matrix distribution.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">quadrature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="mf">-0.9491079123427585</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1294849661688697</span><span class="p">},</span><span class="w">  </span><span class="p">{</span><span class="mf">-0.7415311855993943</span><span class="p">,</span><span class="w"> </span><span class="mf">0.27970539148927664</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="mf">-0.40584515137739696</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3818300505051189</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">6.123233995736766e-17</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4179591836734694</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="mf">0.4058451513773971</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3818300505051189</span><span class="p">},</span><span class="w">   </span><span class="p">{</span><span class="mf">0.7415311855993945</span><span class="p">,</span><span class="w"> </span><span class="mf">0.27970539148927664</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="mf">0.9491079123427585</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1294849661688697</span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
<p>A Model is Kynema’s low level interface for specifying elements, nodes, constraints, and their connectivities.
One everything has been specified, we will use model to create Kynema’s fundamental data structures and advance the problem in time.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">Model</span><span class="p">();</span>
</pre></div>
</div>
<p>The aptly named SetGravity method is used to set the gravity vector for the problem.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">.</span><span class="n">SetGravity</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">-9.81</span><span class="p">);</span>
</pre></div>
</div>
<p>When specifying the beam elements, we’ll also set the initial velocity.
To help formulate this, we specify the rotor velocity (both translational and rotational) and the origin about which we’ll rotate.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">};</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">};</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">hub_radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.</span><span class="p">;</span>
</pre></div>
</div>
<p>We’ll now define three beam elements to be our main rotor.  Each of these beams will be
identical, but we’ll rotate each of them by 120 degrees around the origin to create a
rotor like one would see on a wind turbine.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">num_blades</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">blade_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">blade_number</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_blades</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">blade_number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">beam_node_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">node_s</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cbegin</span><span class="p">(</span><span class="n">node_s</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cend</span><span class="p">(</span><span class="n">node_s</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">beam_node_ids</span><span class="p">),</span>
<span class="w">        </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">AddNode</span><span class="p">().</span><span class="n">SetElemLocation</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="n">SetPosition</span><span class="p">(</span><span class="mf">10.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">).</span><span class="n">Build</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">blade_elem_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">AddBeamElement</span><span class="p">(</span><span class="n">beam_node_ids</span><span class="p">,</span><span class="w"> </span><span class="n">sections</span><span class="p">,</span><span class="w"> </span><span class="n">quadrature</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rotation_quaternion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">math</span><span class="o">::</span><span class="n">RotationVectorToQuaternion</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blade_number</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">num_blades</span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">TranslateBeam</span><span class="p">(</span><span class="n">blade_elem_id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">hub_radius</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">});</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">RotateBeamAboutPoint</span><span class="p">(</span><span class="n">blade_elem_id</span><span class="p">,</span><span class="w"> </span><span class="n">rotation_quaternion</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="p">);</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">SetBeamVelocityAboutPoint</span><span class="p">(</span><span class="n">blade_elem_id</span><span class="p">,</span><span class="w"> </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To control the rotation of the turbine, we create a node to act as a hub and attach
the nearest node of each beam element to the hub with a rigid joint constraint.
We then create a prescribed boundary condidition constraint on the hub, which we will
modify during time stepping to create rotation.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">hub_node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">AddNode</span><span class="p">().</span><span class="n">SetPosition</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">).</span><span class="n">Build</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">beam_element</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">GetBeamElements</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">AddRigidJointConstraint</span><span class="p">({</span><span class="n">hub_node_id</span><span class="p">,</span><span class="w"> </span><span class="n">beam_element</span><span class="p">.</span><span class="n">node_ids</span><span class="p">.</span><span class="n">front</span><span class="p">()});</span>
<span class="p">}</span>
<span class="k">auto</span><span class="w"> </span><span class="n">hub_bc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">AddPrescribedBC</span><span class="p">(</span><span class="n">hub_node_id</span><span class="p">);</span>
</pre></div>
</div>
<p>Now that the problem has been fully described in the model, we will create Kynema’s main data structures: State, Elements, Constraints, and Solver.</p>
<p>The CreateSystem method takes an optional template argument with a Kokkos device describing where the system will reside and run.
By default, it uses Kokkos’ default execution/memory space, so a serial build will run on the CPU, a CUDA build will run on a CUDA device, etc.</p>
<p>The CreateSolver&lt;&gt; function uses the connectivity defined in the State, Elements, and Constraints structures to construct the Solver object.</p>
<p>State contains the current state (position, velocity, etc) information for each node.</p>
<p>Elements contains each a Beams, Masses, and Springs structure.
These contain the connectivity and basis information or all of the elements of the respective type.</p>
<p>Constraints contains the connectivity information for each constraint in the system.</p>
<p>Solver contains the linear system (sparse matrix, RHS) and linear system solver</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">CreateSystem</span><span class="p">();</span>
<span class="k">auto</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">CreateSolver</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">);</span>
</pre></div>
</div>
<p>The final stage is to create a StepParameters object, which contains information like the number of non-linear iterations, time step size, and numerical damping factor used to take a single time step.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">is_dynamic_solve</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">max_iter</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">step_size</span><span class="p">(</span><span class="mf">0.01</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">rho_inf</span><span class="p">(</span><span class="mf">0.9</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">t_end</span><span class="p">(</span><span class="mf">0.1</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">num_steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">(</span><span class="n">t_end</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">step_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">));</span>
<span class="k">auto</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">StepParameters</span><span class="p">(</span><span class="n">is_dynamic_solve</span><span class="p">,</span><span class="w"> </span><span class="n">max_iter</span><span class="p">,</span><span class="w"> </span><span class="n">step_size</span><span class="p">,</span><span class="w"> </span><span class="n">rho_inf</span><span class="p">);</span>
</pre></div>
</div>
<p>Kynema allows the user to control the actual time stepping process.
This includes setting forces, post-processing data, or coupling to other codes.
For this problem, we will prescribe a rotation on the hub boundary condition, which will be transmitted to the blades through their respective constraints.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_steps</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">q_hub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">math</span><span class="o">::</span><span class="n">RotationVectorToQuaternion</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="n">step_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">velocity</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">step_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">velocity</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="w">         </span><span class="n">step_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">velocity</span><span class="p">[</span><span class="mi">5</span><span class="p">]}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">u_hub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="n">q_hub</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">q_hub</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">q_hub</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">q_hub</span><span class="p">[</span><span class="mi">3</span><span class="p">]};</span>
<span class="w">    </span><span class="n">constraints</span><span class="p">.</span><span class="n">UpdateDisplacement</span><span class="p">(</span><span class="n">hub_bc_id</span><span class="p">,</span><span class="w"> </span><span class="n">u_hub</span><span class="p">);</span>
<span class="w">    </span><span class="p">[[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">converged</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">kynema</span><span class="o">::</span><span class="n">Step</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">solver</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">converged</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="spring_mass.html" class="btn btn-neutral float-left" title="Example: Spring-Mass System" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../theory/index.html" class="btn btn-neutral float-right" title="Theory Manual" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 - Present, MIT License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>