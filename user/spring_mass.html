<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example: Spring-Mass System &mdash; Kynema 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Example: Three Blade Rotor" href="three_blade.html" />
    <link rel="prev" title="Example: Heavy Top Problem" href="heavy_top.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Kynema
              <img src="../_static/oturb_logo_v2.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="user.html">User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="compiling.html">Compiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="linking.html">Linking To Kynema</a></li>
<li class="toctree-l2"><a class="reference internal" href="floating_platform.html">Example: Rigid body with three springs</a></li>
<li class="toctree-l2"><a class="reference internal" href="turbine.html">Example: IEA15MW Turbine</a></li>
<li class="toctree-l2"><a class="reference internal" href="heavy_top.html">Example: Heavy Top Problem</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Example: Spring-Mass System</a></li>
<li class="toctree-l2"><a class="reference internal" href="three_blade.html">Example: Three Blade Rotor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../theory/index.html">Theory Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgement.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kynema</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="user.html">User Manual</a></li>
      <li class="breadcrumb-item active">Example: Spring-Mass System</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user/spring_mass.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="example-spring-mass-system">
<h1>Example: Spring-Mass System<a class="headerlink" href="#example-spring-mass-system" title="Permalink to this heading"></a></h1>
<p>This example will walk through how to run a simulation of a chain of masses linked together by linear springs and anchored at either end.
We’ll use Kynema’s low level API, which, unlike Kynema’s high level APIs, will require us to manually set up all nodes and their connectivities.
This extra complexity is the trade-off required for unlimited freedom.
For the most up to date and working version of this code, see <code class="docutils literal notranslate"><span class="pre">tests/documentation_tests/spring_mass_system/</span></code>.</p>
<p>As with any C++ program, start with the includes.
As a Kokkos-based library, you’ll need to include <code class="docutils literal notranslate"><span class="pre">Kokkos_Core.hpp</span></code> for setup, teardown, and working with Kynema’s data structures.
From Kynema, you’ll have to include <code class="docutils literal notranslate"><span class="pre">model.hpp</span></code> for the Model class, our tool for setting up and creating the system, and <code class="docutils literal notranslate"><span class="pre">step.hpp</span></code> for the Step function which performs the action of system asembly and solve.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;array&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Kokkos_Core.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;model/model.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;step/step.hpp&gt;</span>
</pre></div>
</div>
<p>We now create the main function of our program and initialize Kokkos.
We also start a scope around the rest of the program.
This scoping is necessary to ensure that all Kokkos objects are destroyed before finalize is called and the program exits.
Failure to do this will result in lots of nasty, hard to decipher errors on program termination.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Kokkos</span><span class="o">::</span><span class="n">initialize</span><span class="p">();</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Kokkos</span><span class="o">::</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, we define the mass matrix.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">mass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">inertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">mass_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="n">mass</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="w">     </span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="n">mass</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="w">     </span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="n">mass</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="w">     </span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="n">inertia</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="w">     </span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="n">inertia</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="w">     </span><span class="p">},</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">   </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="mf">0.</span><span class="p">,</span><span class="w">      </span><span class="n">inertia</span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
<p>A Model is Kynema’s low level interface for specifying elements, nodes, constraints, and their connectivities.
One everything has been specified, we will use model to create Kynema’s fundamental data structures and advance the problem in time.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">Model</span><span class="p">();</span>
</pre></div>
</div>
<p>To add a node, we call the AddNode method on Model, which creates a NodeBuilder object.
This factory lets us string together function calls to specify the initial position, velocity, and acceleration in a human readable fashion.
Once we finalized by calling the Build method, the NodeBuilder adds a node to the model and returns its newly created ID number.
This ID will be used for specifying elements and constraints.</p>
<p>For this problem, we’ll add a series of equally spaced nodes for each mass and an anchor point at the beginning and end of the list.
We’ll store the node-ids for each of these for later use defining the physics and connectivity information.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">number_of_masses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10U</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">displacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">anchor_node_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="p">{};</span>
<span class="k">auto</span><span class="w"> </span><span class="n">mass_node_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_masses</span><span class="o">&gt;</span><span class="p">{};</span>
<span class="k">auto</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="n">anchor_node_ids</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">AddNode</span><span class="p">().</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">).</span><span class="n">Build</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mass_node_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mass_node_ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">position</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">displacement</span><span class="p">;</span>
<span class="w">    </span><span class="n">mass_node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">AddNode</span><span class="p">().</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">).</span><span class="n">Build</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">position</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">displacement</span><span class="p">;</span>
<span class="n">anchor_node_ids</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">AddNode</span><span class="p">().</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">).</span><span class="n">Build</span><span class="p">();</span>
</pre></div>
</div>
<p>To add a mass element to the model, we will need a single node id number and the mass matrix containing the mass and inertia information.</p>
<p>We’ll add a mass element for each of the mass nodes</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">mass_node_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mass_node_ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">AddMassElement</span><span class="p">(</span><span class="n">mass_node_id</span><span class="p">,</span><span class="w"> </span><span class="n">mass_matrix</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To add a spring to the model, we will need a node id number, a stiffness, and an undisplaced length where the spring force is zero.</p>
<p>We’ll add a spring element between each of the mass elements and between the ending mass elements and our anchor points.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">stiffness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10.</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="n">model</span><span class="p">.</span><span class="n">AddSpringElement</span><span class="p">(</span><span class="n">anchor_node_ids</span><span class="p">.</span><span class="n">front</span><span class="p">(),</span><span class="w"> </span><span class="n">mass_node_ids</span><span class="p">.</span><span class="n">front</span><span class="p">(),</span><span class="w"> </span><span class="n">stiffness</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">number_of_masses</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">AddSpringElement</span><span class="p">(</span><span class="n">mass_node_ids</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="w"> </span><span class="n">mass_node_ids</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1U</span><span class="p">],</span><span class="w"> </span><span class="n">stiffness</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">model</span><span class="p">.</span><span class="n">AddSpringElement</span><span class="p">(</span><span class="n">mass_node_ids</span><span class="p">.</span><span class="n">back</span><span class="p">(),</span><span class="w"> </span><span class="n">anchor_node_ids</span><span class="p">.</span><span class="n">back</span><span class="p">(),</span><span class="w"> </span><span class="n">stiffness</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
</pre></div>
</div>
<p>Each of the anchor nodes requires a fixed boundary condition, which will prevent it from either moving or rotating.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">anchor_node_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">anchor_node_ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">AddFixedBC</span><span class="p">(</span><span class="n">anchor_node_id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now that the problem has been fully described in the model, we will create Kynema’s main data structures: State, Elements, Constraints, and Solver.</p>
<p>The CreateSystem method takes an optional template argument with a Kokkos device describing where the system will reside and run.
By default, it uses Kokkos’ default execution/memory space, so a serial build will run on the CPU, a CUDA build will run on a CUDA device, etc.</p>
<p>The CreateSolver&lt;&gt; function uses the connectivity defined in the State, Elements, and Constraints structures to construct the Solver object.</p>
<p>State contains the current state (position, velocity, etc) information for each node.</p>
<p>Elements contains each a Beams, Masses, and Springs structure.
These contain the connectivity and basis information or all of the elements of the respective type.</p>
<p>Constraints contains the connectivity information for each constraint in the system.</p>
<p>Solver contains the linear system (sparse matrix, RHS) and linear system solver</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">CreateSystem</span><span class="p">();</span>
<span class="k">auto</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">CreateSolver</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">);</span>
</pre></div>
</div>
<p>The final stage is to create a StepParameters object, which contains information like the number of non-linear iterations, time step size, and numerical damping factor used to take a single time step.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">num_steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">is_dynamic_solve</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">max_iter</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">rho_inf</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">final_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">mass</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">stiffness</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">step_size</span><span class="p">(</span><span class="n">final_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">num_steps</span><span class="p">));</span>
<span class="k">auto</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kynema</span><span class="o">::</span><span class="n">StepParameters</span><span class="p">(</span><span class="n">is_dynamic_solve</span><span class="p">,</span><span class="w"> </span><span class="n">max_iter</span><span class="p">,</span><span class="w"> </span><span class="n">step_size</span><span class="p">,</span><span class="w"> </span><span class="n">rho_inf</span><span class="p">);</span>
</pre></div>
</div>
<p>Kynema allows the user to control the actual time stepping process.
This includes setting forces, post-processing data, or coupling to other codes.
In this example, we’ll check that none of the nodes have moved - the chain is in constant tension and equilibrium.</p>
<p>The current state is stored in the State object’s q member.
This is a Kokkos view of size num_nodes x 7.
This view lives on device, so we can’t access it directly from host code.
Here, we create a mirror view on host and, at each time step, copy the data to host and check the value of x-displacement at each node.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Kokkos</span><span class="o">::</span><span class="n">create_mirror_view</span><span class="p">(</span><span class="n">Kokkos</span><span class="o">::</span><span class="n">WithoutInitializing</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">q</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">400</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">converged</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">kynema</span><span class="o">::</span><span class="n">Step</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">solver</span><span class="p">,</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">converged</span><span class="p">);</span>
<span class="w">    </span><span class="n">Kokkos</span><span class="o">::</span><span class="n">deep_copy</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">q</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.</span><span class="n">e</span><span class="mi">-14</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="heavy_top.html" class="btn btn-neutral float-left" title="Example: Heavy Top Problem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="three_blade.html" class="btn btn-neutral float-right" title="Example: Three Blade Rotor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 - Present, MIT License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>