#include <gtest/gtest.h>

#include "src/gebt_poc/NodalGyroscopicMatrix.hpp"

#include "tests/unit_tests/gebt_poc/test_data.h"
#include "tests/unit_tests/gen_alpha_poc/test_utilities.h"

namespace openturbine::gebt_poc {
TEST(SolverTest, NodalGyroscopicMatrix) {
    auto mm = gen_alpha_solver::create_matrix({
        {2.0000000000000009, 5.2041704279304213E-17, -5.5511151231257827E-17, 4.163336342344337E-17,
         0.62605214725880387, -0.33952055713492146},
        {5.2041704279304213E-17, 2.0000000000000018, 1.3877787807814457E-17, -0.62605214725880398,
         3.4694469519536142E-18, 0.22974877626536772},
        {-5.5511151231257827E-17, 1.3877787807814457E-17, 2.0000000000000013, 0.33952055713492141,
         -0.22974877626536766, 1.3877787807814457E-17},
        {-4.163336342344337E-17, -0.62605214725880387, 0.33952055713492146, 1.3196125048858467,
         1.9501108129670985, 3.5958678677753957},
        {0.62605214725880398, -3.4694469519536142E-18, -0.22974877626536772, 1.9501108129670985,
         2.881855217930184, 5.3139393458205735},
        {-0.33952055713492141, 0.22974877626536766, -1.3877787807814457E-17, 3.5958678677753957,
         5.3139393458205726, 9.7985322771839804},
    });
    auto sectional_mass_matrix = MassMatrix(mm);

    auto velocity = gen_alpha_solver::create_vector(
        {0.0025446043828620765, -0.0024798542682092665, 0.000065079641503883005,
         0.0025446043828620765, -0.0024798542682092665, 0.000065079641503883005}
    );

    auto gyroscopic_matrix = Kokkos::View<double**>("gyroscopic_matrix", 6, 6);
    NodalGyroscopicMatrix(velocity, sectional_mass_matrix, gyroscopic_matrix);

    openturbine::gen_alpha_solver::tests::expect_kokkos_view_2D_equal(
        gyroscopic_matrix,
        {// row 1
         {0., 0., 0., -0.00080121825344948408, 0.0020034324646323511, 0.0015631511018243545},
         // row 2
         {0., 0., 0., -0.0022976344789521182, 0.00062536299234839244, -0.0015967098417843995},
         // row 3
         {0., 0., 0., -0.0031711581076346268, 0.0031271320551441812, -0.00025734175971376988},
         // row 4
         {0., 0., 0., -0.0090441407924201148, -0.016755394335528064, -0.022806270184157214},
         // row 5
         {0., 0., 0., -0.0056741321644514023, -0.013394960837037522, -0.025943451454082944},
         // row 6
         {0., 0., 0., 0.006396216051163168, 0.013413253109011812, 0.022439101629457635}}
    );
}
}