name: OpenTurbine CI

on: push
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]

jobs:

  CPU:
    # needs: Formatting
    runs-on: ubuntu-latest
    steps:

    - name: Cache install Spack packages
      id: cache-install
      uses: actions/cache@v2
      with:
        path: |
          ~/.spack
        key: install-spack-v0.20
    - name: Install Spack packages
      if: steps.cache-install.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/spack/spack ~/.spack/Spack
        . ~/.spack/Spack/share/spack/setup-env.sh
        spack install kokkos

    - name: Clone
      uses: actions/checkout@v3
      with: 
        submodules: true
    - name: Test
      run: |
        . ~/.spack/Spack/share/spack/setup-env.sh
        export Kokkos_DIR=/home/runner/.spack/Spack/opt/spack/linux-ubuntu20.04-x86_64_v4/gcc-10.3.0/kokkos-3.7.00-2vkd47kbrzkkcjpcys73mce7vtw6x37p

        mkdir build
        cd build
        cmake ..
        make
        ./test_kokkos

    # - name: Dependencies
    #   run: ${{matrix.install_deps}}
    # - name: Setup
    #   run: |
    #     echo "NUM_PROCS=${{matrix.procs}}" >> $GITHUB_ENV
    # - name: Configure
    #   run: |
    #     cmake -G Ninja \
    #       -B ${{runner.workspace}}/build-ci-${{matrix.build_type}} \
    #       -DCMAKE_INSTALL_PREFIX:PATH=${{runner.workspace}}/install-${{matrix.build_type}} \
    #       -DCMAKE_BUILD_TYPE:STRING=${{matrix.build_type}} \
    #       ${{github.workspace}}
    # - name: Build
    #   working-directory: ${{runner.workspace}}/build-ci-${{matrix.build_type}}
    #   run: |
    #     echo "::add-matcher::.github/problem-matchers/gcc.json"
    #     cmake --build . -- -j ${{env.NUM_PROCS}} 2>&1 | tee -a build-output.txt
    # - name: Test
    #   working-directory: ${{runner.workspace}}/build-ci-${{matrix.build_type}}
    #   run: |
    #     ctest ${{matrix.ctest_args}} --output-on-failure


